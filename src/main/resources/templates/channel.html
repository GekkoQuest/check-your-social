<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:with="title='Channel'"
      th:replace="~{fragments/_layout :: layout(~{::content})}">
<th:block th:fragment="content">
<div class="hero">
        <img th:if="${channel.avatarUrl != null}" th:src="${channel.avatarUrl}" class="avatar-lg" alt="avatar"/>
        <div>
            <h1 th:text="${channel.title}">Channel Title</h1>
            <p class="muted" th:text="${channel.handle}">@handle</p>
        </div>
    </div>

    <!-- Chart -->
    <section th:if="${history != null and !history.isEmpty()}" style="height:320px;">
        <canvas id="subsChart" width="600" height="320"></canvas>

        <!-- Simple chart data without fancy mapping -->
        <div id="chart-data" style="display:none;"
             th:attr="data-dates=${#strings.listJoin(history.![snapshotDate], ',')},
                      data-values=${#strings.listJoin(history.![subscribers], ',')}">
        </div>

        <script>
            (function(){
                const el = document.getElementById('chart-data');
                if (!el) return;

                const dates = el.getAttribute('data-dates')?.split(',') || [];
                const values = el.getAttribute('data-values')?.split(',').map(v => Number(v) || 0) || [];

                const ctx = document.getElementById('subsChart')?.getContext('2d');
                if (!ctx || dates.length === 0) return;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Subscribers',
                            data: values,
                            fill: false,
                            tension: 0.2,
                            borderColor: '#007bff',
                            backgroundColor: '#007bff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
                            y: { beginAtZero: false }
                        },
                        plugins: { legend: { display: true } }
                    }
                });
            })();
        </script>
    </section>

    <!-- Optional: friendly message when there is no history yet -->
    <div th:if="${history == null or history.isEmpty()}" class="muted" style="margin: .5rem 0;">
        No snapshots yet. Check back after the next crawl.
    </div>

    <h3>Daily snapshots</h3>
    <table class="table">
        <thead>
        <tr>
            <th>Date</th><th>Subscribers</th><th>Views</th><th>Videos</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="s : ${history}">
            <td th:text="${s.snapshotDate}">2025-08-14</td>
            <td th:text="${#numbers.formatInteger(s.subscribers ?: 0, 0, 'COMMA')}">0</td>
            <td th:text="${#numbers.formatInteger(s.views ?: 0, 0, 'COMMA')}">0</td>
            <td th:text="${#numbers.formatInteger(s.videos ?: 0, 0, 'COMMA')}">0</td>
        </tr>
        </tbody>
    </table>
</th:block>
</html>
