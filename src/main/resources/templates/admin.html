<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:with="title='Admin'"
      th:replace="~{fragments/_layout :: layout(~{::content})}">
<th:block th:fragment="content">
    <div class="hero">
        <h1>Admin Panel</h1>
        <p class="muted">Enhanced controls for rapid channel discovery and management</p>
    </div>

    <div style="display: grid; gap: 2rem; max-width: 1000px;">

        <!-- Quick Start Section -->
        <section style="border: 2px solid #28a745; padding: 1.5rem; border-radius: 8px; background: rgba(40, 167, 69, 0.05);">
            <h3>üöÄ Quick Start (Recommended Order)</h3>
            <p class="muted">Follow this sequence to rapidly populate your database</p>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button onclick="seedPopular()" style="background: #28a745;">1. Seed Popular Channels</button>
                <button onclick="massDiscovery()" style="background: #007bff;">2. Mass Discovery</button>
                <button onclick="batchSnapshot()" style="background: #6f42c1;">3. Batch Snapshot</button>
                <button onclick="getStats()" style="background: #17a2b8;">4. Check Progress</button>
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                <strong>Expected Result:</strong> 1000+ channels with real subscriber data in ~15 minutes
            </div>
        </section>

        <!-- Debug & Testing Section -->
        <section style="border: 1px solid #dc3545; padding: 1.5rem; border-radius: 8px;">
            <h3>üîß Debug & Testing</h3>
            <p class="muted">Diagnostic tools to identify and fix issues</p>

            <!-- YouTube API Testing -->
            <div style="margin: 1rem 0;">
                <h4>YouTube API Testing</h4>
                <form onsubmit="debugYouTube(event)" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <input name="handle" placeholder="@mkbhd or channel URL" required style="flex: 1;"/>
                    <button type="submit">üîç Test YouTube API</button>
                </form>
            </div>

            <!-- Handle Fixing by Page Range -->
            <div style="margin: 1rem 0;">
                <h4>Fix Handles by Page Range</h4>
                <form onsubmit="fixHandlesRange(event)" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <input name="startPage" type="number" placeholder="Start page (4)" min="0" required style="width: 100px;"/>
                    <input name="endPage" type="number" placeholder="End page (10)" min="0" required style="width: 100px;"/>
                    <button type="submit">üîß Fix Page Range</button>
                </form>
                <small style="color: #666; margin-top: 0.5rem; display: block;">
                    Use this to fix specific page ranges where you see unknown handles. Pages start at 0.
                </small>
            </div>

            <div id="debugResult" style="margin-top: 1rem; padding: 0.5rem; display: none;"></div>
        </section>

        <!-- Ingest new channel -->
        <section style="border: 1px solid #ddd; padding: 1.5rem; border-radius: 8px;">
            <h3>‚ûï Add Individual Channel</h3>
            <form id="ingestForm" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <select name="platform" required>
                    <option value="YOUTUBE">YouTube</option>
                    <option value="TWITCH">Twitch</option>
                </select>
                <input name="handleOrUrl" placeholder="@mkbhd or full URL" required style="flex: 1;"/>
                <button type="submit">Add Channel</button>
            </form>
            <div id="ingestResult" style="margin-top: 1rem; padding: 0.5rem; display: none;"></div>
        </section>

        <!-- Enhanced Discovery Methods -->
        <section style="border: 1px solid #007bff; padding: 1.5rem; border-radius: 8px;">
            <h3>üîç Advanced Discovery Methods</h3>
            <p class="muted">Multiple strategies to rapidly find and add channels</p>

            <!-- Primary Discovery Actions -->
            <div style="margin: 1rem 0;">
                <h4>Primary Discovery</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                    <button onclick="massDiscovery()" style="background: #007bff;">üöÄ Mass Discovery</button>
                    <button onclick="seedPopular()" style="background: #28a745;">‚≠ê Seed Popular</button>
                    <button onclick="discoverTrending()" style="background: #fd7e14;">üî• Trending Discovery</button>
                    <button onclick="discoverRelated()" style="background: #6f42c1;">üîó Related Discovery</button>
                </div>
            </div>

            <!-- Legacy Discovery -->
            <div style="margin: 1rem 0;">
                <h4>Manual Discovery</h4>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
                    <button onclick="discoverNow()">üéØ Run Discovery Now</button>
                    <button onclick="getStats()">üìä View Stats</button>
                </div>
            </div>

            <!-- Search-based Discovery -->
            <div style="margin: 1rem 0;">
                <h4>Search-Based Discovery</h4>
                <form onsubmit="discoverChannels(event)" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <input name="searchTerm" placeholder="tech reviews, gaming, cooking..." required style="flex: 1;"/>
                    <button type="submit">üîç Discover by Search</button>
                </form>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <small style="color: #666;">Quick searches:</small>
                    <button onclick="quickDiscover('tech review')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Tech</button>
                    <button onclick="quickDiscover('gaming')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Gaming</button>
                    <button onclick="quickDiscover('cooking')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Cooking</button>
                    <button onclick="quickDiscover('fitness')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Fitness</button>
                    <button onclick="quickDiscover('music')" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Music</button>
                </div>
            </div>

            <div id="discoveryResult" style="margin-top: 1rem; padding: 0.5rem; display: none;"></div>

            <!-- Discovery Info -->
            <div style="margin-top: 1rem; padding: 1rem; background: #e3f2fd; border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0; color: #1565c0;">How Enhanced Discovery Works:</h4>
                <ul style="margin: 0; font-size: 0.9rem; color: #1565c0;">
                    <li><strong>Mass Discovery:</strong> Runs all methods - can add 500-1000 channels in one session</li>
                    <li><strong>Trending Discovery:</strong> Finds viral/popular channels using trending search terms</li>
                    <li><strong>Related Discovery:</strong> Uses existing channels to find similar content creators</li>
                    <li><strong>Auto Mode:</strong> Rapid discovery every 15min until 1000 channels, then daily</li>
                </ul>
            </div>
        </section>

        <!-- Data Management -->
        <section style="border: 1px solid #6f42c1; padding: 1.5rem; border-radius: 8px;">
            <h3>üìä Data Management & Snapshots</h3>
            <p class="muted">Update channel statistics and maintain data quality</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <button onclick="batchSnapshot()">üì∏ Batch Snapshot</button>
                <button onclick="snapshotAll()">üì∏ Snapshot All</button>
                <button onclick="fixUnknownHandles()">üîß Fix Unknown Handles</button>
                <button onclick="listChannels()">üìã List Channels</button>
                <button onclick="healthCheck()">üè• Health Check</button>
                <button onclick="systemStatus()">üñ•Ô∏è System Status</button>
                <button onclick="cleanupDuplicates()">üßπ Cleanup</button>
                <button onclick="debugDb()">üîß Debug DB</button>
            </div>

            <div id="snapshotResult" style="margin-top: 1rem; padding: 0.5rem; display: none;"></div>
        </section>

        <!-- System Information -->
        <section style="border: 1px solid #17a2b8; padding: 1.5rem; border-radius: 8px;">
            <h3>‚ÑπÔ∏è System Information</h3>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button onclick="getStats()">üìä Discovery Stats</button>
                <button onclick="healthCheck()">üè• Health Check</button>
                <button onclick="systemStatus()">üñ•Ô∏è System Status</button>
            </div>
        </section>

        <!-- Quick links -->
        <section style="border: 1px solid #28a745; padding: 1.5rem; border-radius: 8px;">
            <h3>üîó Quick Navigation</h3>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <a href="/leaderboard" class="button" style="background: #28a745;">üìà View Leaderboard</a>
                <a href="/" class="button" style="background: #17a2b8;">üè† Home</a>
                <a href="/leaderboard?platform=YOUTUBE" class="button">üì∫ YouTube Leaderboard</a>
                <a href="/leaderboard?platform=TWITCH" class="button">üéÆ Twitch Leaderboard</a>
            </div>
        </section>
    </div>

    <script>
        // Add loading states for buttons
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.textContent = '‚è≥ Processing...';
                button.disabled = true;
            } else {
                button.textContent = button.dataset.originalText || button.textContent;
                button.disabled = false;
            }
        }

        // Handle ingest form
        document.getElementById('ingestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const platform = formData.get('platform');
            const handleOrUrl = formData.get('handleOrUrl');
            const submitButton = e.target.querySelector('button[type="submit"]');

            try {
                setButtonLoading(submitButton, true);
                showResult('ingestResult', 'üîç Adding channel...', true);

                const response = await fetch(`/admin/ingest/${platform}?handleOrUrl=${encodeURIComponent(handleOrUrl)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });

                const result = await response.text();
                showResult('ingestResult', result, response.ok);

                if (response.ok) {
                    e.target.reset();
                }
            } catch (error) {
                console.error('Ingest error:', error);
                showResult('ingestResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(submitButton, false);
            }
        });

        // Debug functions
        async function debugYouTube(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const handle = formData.get('handle');
            const submitButton = event.target.querySelector('button[type="submit"]');

            try {
                setButtonLoading(submitButton, true);
                showResult('debugResult', `üîç Testing YouTube API for "${handle}"...`, true);

                const response = await fetch(`/admin/debug-youtube?handle=${encodeURIComponent(handle)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('debugResult', result, true);
            } catch (error) {
                console.error('Debug error:', error);
                showResult('debugResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(submitButton, false);
            }
        }

        async function fixHandlesRange(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const startPage = formData.get('startPage');
            const endPage = formData.get('endPage');
            const submitButton = event.target.querySelector('button[type="submit"]');

            try {
                setButtonLoading(submitButton, true);
                showResult('debugResult', `üîß Fixing handles for pages ${startPage}-${endPage}...`, true);

                const response = await fetch(`/admin/fix-handles-range?startPage=${startPage}&endPage=${endPage}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('debugResult', result, true);
            } catch (error) {
                console.error('Fix range error:', error);
                showResult('debugResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(submitButton, false);
            }
        }

        // Discovery functions with improved error handling
        async function seedPopular() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', 'üå± Seeding popular channels... this will add ~50 high-quality channels.', true);

                const response = await fetch('/admin/seed-popular', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Seed popular error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function massDiscovery() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', 'üöÄ Running mass discovery... this may take 10-15 minutes and add 500-1000 channels!', true);

                const response = await fetch('/admin/mass-discovery', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Mass discovery error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function discoverTrending() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', 'üî• Discovering trending channels...', true);

                const response = await fetch('/admin/discover-trending', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Discover trending error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function discoverRelated() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', 'üîó Discovering related channels...', true);

                const response = await fetch('/admin/discover-related', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Discover related error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function discoverNow() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', 'üéØ Running discovery...', true);

                const response = await fetch('/admin/discover-now', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Discover now error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function batchSnapshot() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('snapshotResult', 'üì∏ Running batch snapshot... updating channel statistics.', true);

                const response = await fetch('/admin/batch-snapshot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Batch snapshot error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function snapshotAll() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('snapshotResult', 'üì∏ Snapshotting all channels... this may take a while.', true);

                const response = await fetch('/admin/snapshot-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Snapshot all error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function fixUnknownHandles() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('snapshotResult', 'üîß Fixing unknown handles...', true);

                const response = await fetch('/admin/fix-unknown-handles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Fix handles error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function listChannels() {
            const button = event.target;
            try {
                setButtonLoading(button, true);

                const response = await fetch('/admin/channels', {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('List channels error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function healthCheck() {
            const button = event.target;
            try {
                setButtonLoading(button, true);

                const response = await fetch('/admin/health-check', {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Health check error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function systemStatus() {
            const button = event.target;
            try {
                setButtonLoading(button, true);

                const response = await fetch('/admin/system-status', {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('System status error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function cleanupDuplicates() {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('snapshotResult', 'üßπ Cleaning up duplicates...', true);

                const response = await fetch('/admin/cleanup-duplicates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Cleanup error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function debugDb() {
            const button = event.target;
            try {
                setButtonLoading(button, true);

                const response = await fetch('/admin/debug-db', {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('snapshotResult', result, true);
            } catch (error) {
                console.error('Debug error:', error);
                showResult('snapshotResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        async function getStats() {
            const button = event.target;
            try {
                setButtonLoading(button, true);

                const response = await fetch('/admin/discovery-stats', {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Get stats error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Manual discovery by search term
        async function discoverChannels(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const searchTerm = formData.get('searchTerm');
            const submitButton = event.target.querySelector('button[type="submit"]');

            try {
                setButtonLoading(submitButton, true);
                showResult('discoveryResult', `üîç Discovering channels for "${searchTerm}"...`, true);

                const response = await fetch(`/admin/discover?searchTerm=${encodeURIComponent(searchTerm)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);

                // Clear the form on success
                event.target.reset();
            } catch (error) {
                console.error('Discovery error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(submitButton, false);
            }
        }

        // Quick discover function for preset terms
        async function quickDiscover(term) {
            const button = event.target;
            try {
                setButtonLoading(button, true);
                showResult('discoveryResult', `üîç Quick discovering "${term}" channels...`, true);

                const response = await fetch(`/admin/discover?searchTerm=${encodeURIComponent(term)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.text();
                showResult('discoveryResult', result, true);
            } catch (error) {
                console.error('Quick discover error:', error);
                showResult('discoveryResult', 'Error: ' + error.message, false);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // Show result helper with better formatting
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message.replace(/\n/g, '<br>'); // Convert newlines to <br>
            element.style.display = 'block';
            element.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
            element.style.color = isSuccess ? '#155724' : '#721c24';
            element.style.border = `1px solid ${isSuccess ? '#c3e6cb' : '#f5c6cb'}`;
            element.style.borderRadius = '4px';
            element.style.fontFamily = 'monospace';
            element.style.fontSize = '0.9rem';
            element.style.whiteSpace = 'pre-line';
            element.style.maxHeight = '400px';
            element.style.overflowY = 'auto';

            // Auto-scroll to the result
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Add global error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // Optionally show user-friendly error
            showResult('discoveryResult', 'Unexpected error occurred. Please check console and try again.', false);
        });
    </script>
</th:block>
</html>